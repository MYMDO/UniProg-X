name: Firmware CI/CD

on:
  push:
    paths:
      - 'firmware/**'
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build & Publish
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            ~/.cache/pip
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Get Date
        id: date
        run: echo "date=$(date +'%Y-%m-%d %H:%M')" >> $GITHUB_OUTPUT

      - name: Compile Firmware
        working-directory: ./firmware
        run: |
          pio run -e pico
        
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-uf2
          path: firmware/.pio/build/pico/firmware.uf2
          retention-days: 5

      - name: Update 'latest' Tag
        # This step moves the 'latest' tag to the current commit
        if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: actions/github-script@v7
        with:
          script: |
            try {
              try {
                // Try to delete the ref if it exists
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: 'tags/latest'
                });
              } catch (e) {
                // Ignore 422/404 if tag doesn't exist
                console.log('Tag delete failed (might not exist): ' + e.message);
              }
              
              // Create the ref at new SHA
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: 'refs/tags/latest',
                sha: context.sha
              });
            } catch (error) {
              core.setFailed(error.message);
            }

      - name: Publish to Releases
        uses: softprops/action-gh-release@v1
        if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        with:
          tag_name: latest
          name: Latest Rolling Build
          body: |
            ðŸš€ **Automatic Build**
            
            This release is automatically updated with the latest changes from the `firmware` directory.
            
            **Build Info**:
            - Commit: `${{ github.sha }}`
            - Date: `${{ steps.date.outputs.date }}`
          files: |
            firmware/.pio/build/pico/firmware.uf2
          prerelease: true
